# üöÄ GitOps avec Flux et Argo CD

## 1. Introduction

Le **GitOps** est une approche o√π l‚Äô**√©tat d√©sir√©** de l‚Äôinfrastructure et des applications est d√©crit **d√©clarativement** dans Git, et o√π des op√©rateurs dans le cluster **concilient en continu** l‚Äô√©tat r√©el avec cet √©tat d√©sir√©.

Principes cl√©s‚Äâ:

- Source de v√©rit√© unique‚Äâ: Git
- Flux de changement via PR/MR, auditable et r√©versible
- Reconciliation ‚Äúpull‚Äëbased‚Äù depuis le cluster (s√©curit√©)
- D√©tection et correction de d√©rive (drift)

Outils majeurs‚Äâ: **Flux** et **Argo CD** (tous deux CNCF, pull‚Äëbased, declaratifs).

---

## 2. Structurer un repo GitOps

Arborescence typique‚Äâ:

```
‚îú‚îÄ clusters/
‚îÇ  ‚îú‚îÄ prod/
‚îÇ  ‚îÇ  ‚îú‚îÄ flux-system/        # bootstrap du contr√¥leur
‚îÇ  ‚îÇ  ‚îú‚îÄ apps/               # app sets pour prod
‚îÇ  ‚îÇ  ‚îî‚îÄ infra/              # ingress, monitoring, policies‚Ä¶
‚îÇ  ‚îî‚îÄ staging/
‚îÇ     ‚îú‚îÄ flux-system/
‚îÇ     ‚îú‚îÄ apps/
‚îÇ     ‚îî‚îÄ infra/
‚îú‚îÄ apps/
‚îÇ  ‚îî‚îÄ webapp/
‚îÇ     ‚îú‚îÄ base/               # manifests ou chart ref
‚îÇ     ‚îî‚îÄ overlays/
‚îÇ        ‚îú‚îÄ prod/
‚îÇ        ‚îî‚îÄ staging/
‚îî‚îÄ infra/
   ‚îú‚îÄ ingress/
   ‚îî‚îÄ monitoring/
```

Recommandations‚Äâ: Kustomize pour overlays, secrets avec SOPS, dossiers s√©par√©s par environnement, conventions de nommage stables.

---

## 3. Flux CD ‚Äî composants et CRDs

Composants principaux‚Äâ:

- source‚Äëcontroller‚Äâ: g√®re Git/OCI/Bucket sources
- kustomize‚Äëcontroller‚Äâ: rend et applique des Kustomizations
- helm‚Äëcontroller‚Äâ: g√®re HelmRelease/HelmRepository
- notification‚Äëcontroller‚Äâ: alerting et events
- image‚Äëautomation‚Äâ: mise √† jour d‚Äôimages (optionnel)

CRDs usuelles‚Äâ:

- GitRepository, OCIRepository, HelmRepository, Bucket
- Kustomization
- HelmRelease

### 3.1 Bootstrap (concept)

```bash
# Exemple conceptuel
flux bootstrap github \
  --owner ACME \
  --repository platform-gitops \
  --branch main \
  --path clusters/prod
```

### 3.2 D√©clarer une source Git et une Kustomization

```yaml
apiVersion: source.toolkit.fluxcd.io/v1
kind: GitRepository
metadata:
  name: platform
  namespace: flux-system
spec:
  interval: 1m
  url: https://github.com/ACME/platform-gitops
  ref:
    branch: main
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: apps-prod
  namespace: flux-system
spec:
  interval: 1m
  prune: true
  sourceRef:
    kind: GitRepository
    name: platform
  path: ./clusters/prod/apps
  healthChecks:
  - apiVersion: apps/v1
    kind: Deployment
    name: webapp
    namespace: prod
```

### 3.3 Helm avec Flux

```yaml
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: bitnami
  namespace: flux-system
spec:
  interval: 1h
  url: https://charts.bitnami.com/bitnami
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: redis
  namespace: data
spec:
  interval: 5m
  chart:
    spec:
      chart: redis
      version: 17.x.x
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
  values:
    architecture: standalone
```

---

## 4. Argo CD ‚Äî composants et notions

Composants principaux‚Äâ:

- argocd‚Äëserver‚Äâ: UI/API
- application‚Äëcontroller‚Äâ: reconciliation
- repo‚Äëserver‚Äâ: op√©rations Git/helm/kustomize
- dex (optionnel)‚Äâ: SSO

Objets cl√©s‚Äâ:

- Application‚Äâ: d√©finit une source (repo/chemin/branche) et une destination (cluster/ns)
- AppProject‚Äâ: scope, RBAC, politiques communes

### 4.1 Application simple (Kustomize)

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: webapp
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/ACME/platform-gitops
    targetRevision: main
    path: apps/webapp/overlays/prod
  destination:
    server: https://kubernetes.default.svc
    namespace: prod
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
```

### 4.2 App of Apps (composition)

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: prod
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/ACME/platform-gitops
    targetRevision: main
    path: clusters/prod/apps
    directory:
      recurse: true
  destination:
    server: https://kubernetes.default.svc
    namespace: argocd
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
```

### 4.3 AppProject (multi‚Äëtenancy)

```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: team-a
  namespace: argocd
spec:
  destinations:
  - namespace: team-a
    server: https://kubernetes.default.svc
  sourceRepos:
  - https://github.com/ACME/team-a-*
  clusterResourceWhitelist:
  - group: "*"
    kind: "*"
```

---

## 5. Comparatif Flux vs Argo CD

- Interface‚Äâ: Argo CD offre une UI riche; Flux est ‚ÄúCLI/CRD‚Äëfirst‚Äù (UI via addons/Weave GitOps)
- Mod√©lisation‚Äâ: Flux s‚Äôappuie fortement sur des CRDs (Kustomization, HelmRelease) ; Argo CD mod√©lise via Application/AppProject
- Helm‚Äâ: support natif dans les deux (Flux via helm‚Äëcontroller, Argo via repo‚Äëserver)
- Notifications‚Äâ: int√©gr√©es c√¥t√© Flux (notification‚Äëcontroller) ; Argo via Argo CD Notifications
- Image automation‚Äâ: int√©gr√© dans Flux ; Argo via Argo Image Updater
- Multi‚Äëtenancy‚Äâ: les deux le g√®rent (AppProject vs namespaces/CRDs)

Choix pratique‚Äâ: 

- Flux si vous privil√©giez 100% CRD/Kubernetes natif et Git pur
- Argo CD si vous souhaitez une UI de pilotage avanc√©e et un √©cosyst√®me Argo

---

## 6. S√©curit√©, secrets et politiques

- Secrets‚Äâ: chiffrer avec **SOPS**‚Äâ; Flux et Argo peuvent d√©chiffrer √† l‚Äôapplication
- Acc√®s Git‚Äâ: cl√©s d√©ploy√©es c√¥t√© cluster (pull‚Äëbased), √©viter acc√©s sortants larges
- RBAC‚Äâ: isoler par namespaces/projets ; restreindre les permissions des contr√¥leurs
- Policies‚Äâ: admission controllers (OPA/Gatekeeper, Kyverno) pour valider les manifests

Exemple SOPS + Flux (concept)‚Äâ:

```bash
sops -e secrets.yaml > secrets.enc.yaml
# Flux d√©chiffre au runtime si la cl√© est pr√©sente dans le cluster
```

---

## 7. Bonnes pratiques

- Un repo par ‚Äúplateforme‚Äù + arbo par environnements (prod/staging/dev)
- Kustomize overlays, pas de duplication de manifests
- Petits lots de changements via PR/MR, revues obligatoires
- Activer prune + self‚Äëheal (Argo) / prune + healthChecks (Flux)
- Valider en CI‚Äâ: `kustomize build`, `helm template`, `kubeconform`
- Observabilit√©‚Äâ: exporter √©v√®nements (Flux notifications, Argo notifications)

---

## 8. Commandes utiles

Flux‚Äâ:

- `flux check` ‚Äî diagnostic d‚Äôinstallation
- `flux get kustomizations -A`
- `flux get sources git -A`
- `flux reconcile kustomization <name> -n flux-system`

Argo CD‚Äâ:

- `argocd login <server>` puis `argocd app list`
- `argocd app sync <app>` / `argocd app rollback <app>`
- `argocd proj list` / `argocd proj allow-cluster-resource`

---

## 9. R√©sum√©

Le GitOps fiabilise les d√©ploiements‚Äâ: Git comme v√©rit√©, op√©rateurs qui concilient en continu, audit et rollback natifs. **Flux** et **Argo CD** proposent deux approches compl√©mentaires‚Äâ: CRD‚Äëfirst et UI‚Äëdriven. En ma√Ætrisant leurs CRDs/Applications, vous obtenez des pipelines d√©claratifs, s√ªrs et reproductibles pour vos clusters Kubernetes.

