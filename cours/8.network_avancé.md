# üåê R√©seau avanc√© dans Kubernetes


## 1. Objectifs

Ce module compl√®te l‚Äôintroduction r√©seau (cf. 5.network.md) avec les sujets d‚Äôexposition externe, le contr√¥le fin des flux, et les architectures modernes.

Au programme‚Äâ:

- Ingress et Ingress Controller
- Gateway API (rempla√ßant moderne d‚ÄôIngress)
- Egress, acc√®s sortant et contr√¥le DNS
- LoadBalancer en bare-metal (MetalLB)
- Service Mesh (Istio/Linkerd) ‚Äî principes
- Multi-r√©seaux (Multus) et cas avanc√©s

---

## 2. Ingress: exposer des HTTP(S)

Un Ingress est une ressource L7 (HTTP/HTTPS) qui route du trafic externe vers des Services internes selon des r√®gles de nom d‚Äôh√¥te et de chemin.

### 2.1 Ingress Controller

L‚ÄôIngress tout seul ne fait rien‚Äâ; il faut un **Ingress Controller** (Nginx, HAProxy, Traefik, Kong, etc.) qui observe l‚ÄôAPI et configure un proxy L7.

| Controller | Atouts principaux |
| ---------- | ----------------- |
| NGINX      | R√©f√©rence, riche en annotations |
| Traefik    | Simple, dynamique, support CRD |
| HAProxy    | Performant, tr√®s configurable |
| Kong       | API Gateway, plugins avanc√©s |

### 2.2 Exemple d‚ÄôIngress basique

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: webapp
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
  - host: webapp.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: webapp
            port:
              number: 80
```

‚Üí Route `https://webapp.example.com/` vers le Service `webapp:80`.

### 2.3 TLS

```yaml
spec:
  tls:
  - hosts:
    - webapp.example.com
    secretName: webapp-tls
```

Le secret TLS est de type `kubernetes.io/tls` (cl√© priv√©e + certificat). Souvent g√©r√© via cert-manager.

---

## 3. Gateway API: l‚ÄôIngress de nouvelle g√©n√©ration

La Gateway API remplace progressivement Ingress‚Äâ: mod√®le plus modulaire, objets d√©di√©s (GatewayClass, Gateway, HTTPRoute, TLSRoute‚Ä¶), meilleure portabilit√© et extension.

### 3.1 Objets cl√©s

- `GatewayClass`‚Äâ: type de gateway (impl√©mentation du fournisseur/contr√¥leur)
- `Gateway`‚Äâ: instance d√©ploy√©e qui √©coute sur des adresses/ports
- `HTTPRoute`‚Äâ: r√®gles de routage HTTP vers des backends (Services)

### 3.2 Exemple minimal

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: public-gw
spec:
  gatewayClassName: nginx
  listeners:
  - name: https
    protocol: HTTPS
    port: 443
    hostname: webapp.example.com
    tls:
      mode: Terminate
      certificateRefs:
      - kind: Secret
        name: webapp-tls
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: webapp-route
spec:
  parentRefs:
  - name: public-gw
  hostnames: ["webapp.example.com"]
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: "/"
    backendRefs:
    - name: webapp
      port: 80
```

‚Üí La `Gateway` √©coute en 443 et la `HTTPRoute` envoie sur `webapp:80`.

---

## 4. Egress: trafic sortant et contr√¥le

Par d√©faut, les pods peuvent sortir vers Internet si le n≈ìud le permet. En production, on contr√¥le souvent les flux sortants.

### 4.1 Egress via NAT/Node

- Les pods sortent avec l‚ÄôIP du n≈ìud (SNAT)
- Les pare-feux externes voient l‚ÄôIP des n≈ìuds, pas des pods

### 4.2 Egress contr√¥l√©

- `NetworkPolicy` egress pour limiter les destinations/ports
- Egress Gateway (Calico/Cilium) pour sortir via des IP d√©di√©es
- Proxy obligatoires (HTTP/HTTPS proxy, egress proxy)

Exemple d‚Äôegress restrictif‚Äâ:

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: restrict-egress
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes: [Egress]
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: TCP
      port: 53
```

‚Üí Autorise uniquement le DNS sortant vers kube-system:53.

---

## 5. LoadBalancer en bare‚Äëmetal: MetalLB

En environnement on‚Äëprem, pas de LB cloud manag√©. **MetalLB** fournit des IP de service de type LoadBalancer.

### 5.1 Modes d‚Äôannonce

- Layer 2‚Äâ: annonce ARP/NDP d‚Äôune IP au r√©seau local
- BGP‚Äâ: peering avec des routeurs pour annoncer des prefixes

### 5.2 Exemple de pool d‚Äôadresses (L2)

```yaml
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: default
  namespace: metallb-system
spec:
  addresses:
  - 192.0.2.100-192.0.2.120
---
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: l2
  namespace: metallb-system
spec: {}
```

‚Üí Les Services `type: LoadBalancer` re√ßoivent des IP du pool.

---

## 6. Service Mesh: principes

Un Service Mesh ajoute un plan de donn√©es (sidecars) + plan de contr√¥le pour g√©rer‚Äâ: mTLS, retries, timeouts, canary, observabilit√©.

| Mesh     | Points forts |
| -------- | ------------ |
| Istio    | Tr√®s complet, mTLS, envoy, traffic shaping, observabilit√© |
| Linkerd  | Plus l√©ger, focus performance et simplicit√© |

Sch√©ma logique‚Äâ:

```
Pod A (app) + sidecar <‚Äî> sidecar + Pod B (app)
          ^               ^
          |‚Äî mTLS, policy, retries, metrics ‚Äî|
```

Exemples d‚Äôusages‚Äâ:

- mTLS transparent entre services
- Circuit‚Äëbreaking, retries, timeouts par service
- A/B testing, canary, progressive delivery

---

## 7. Multi‚Äër√©seaux: Multus CNI

Multus permet d‚Äôattacher plusieurs interfaces/CNI √† un pod (cas NFV, stockage, data‚Äëplane sp√©cialis√©).

### 7.1 Principe

- `CNI principale` pour la connectivit√© cluster
- `CNI(s) additionnelle(s)` pour r√©seaux d√©di√©s (SR‚ÄëIOV, macvlan,‚Ä¶)

### 7.2 Exemple (annotation)

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: multi-net-pod
  annotations:
    k8s.v1.cni.cncf.io/networks: '[
      {"name": "net-1"},
      {"name": "net-2", "namespace": "networks"}
    ]'
spec:
  containers:
  - name: app
    image: busybox
    command: ["sh", "-c", "sleep 3600"]
```

‚Üí Le pod re√ßoit des interfaces suppl√©mentaires selon les NetworkAttachmentDefinition.

---

## 8. Bonnes pratiques et d√©pannage

- Standardiser l‚Äôexposition‚Äâ: privil√©gier Gateway API √† moyen terme
- Centraliser TLS via cert‚Äëmanager et des secrets g√©r√©s
- Restreindre egress par d√©faut, ouvrir au cas par cas
- En bare‚Äëmetal, utiliser MetalLB ou un LB interne
- Surveiller la sant√© L7 (probes, logs proxy) et L3/L4 (CNI, routes)
- Outils utiles‚Äâ: `kubectl describe`, `kubectl logs -n ingress-nginx`, `kubectl get endpoints`, `dig/nslookup` dans un pod debug, `cilium monitor`/`calicoctl`

---

## 9. R√©sum√©

Vous savez maintenant‚Äâ:

- Exposer des applications via Ingress ou Gateway API
- G√©rer le TLS et les noms d‚Äôh√¥tes
- Contr√¥ler le trafic sortant (egress)
- Fournir du LoadBalancer on‚Äëprem avec MetalLB
- Comprendre les apports d‚Äôun Service Mesh
- Utiliser des multi‚Äër√©seaux avec Multus

Ces briques compl√®tent le mod√®le r√©seau de base pour des d√©ploiements Kubernetes robustes et s√©curis√©s en production.

