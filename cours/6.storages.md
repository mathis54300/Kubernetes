# ğŸ’¾ Stockage, persistance et volumes dans Kubernetes

## 1. Introduction

Par nature, Kubernetes gÃ¨re des applications **Ã©phÃ©mÃ¨res** :
les **pods** peuvent Ãªtre supprimÃ©s, dÃ©placÃ©s ou redÃ©ployÃ©s Ã  tout moment.

Mais toutes les donnÃ©es ne peuvent pas Ãªtre Ã©phÃ©mÃ¨res :
bases de donnÃ©es, fichiers dâ€™application, logs ou sauvegardes nÃ©cessitent un **stockage persistant**.

Câ€™est lÃ  quâ€™interviennent les **volumes Kubernetes** : ils permettent de **sÃ©parer la durÃ©e de vie des donnÃ©es** de celle des pods qui les utilisent.

---

## 2. Le problÃ¨me de lâ€™Ã©phÃ©mÃ©ritÃ©

Lorsquâ€™un conteneur meurt :

* son systÃ¨me de fichiers disparaÃ®t,
* toutes les donnÃ©es Ã©crites Ã  lâ€™intÃ©rieur sont perdues,
* et un nouveau conteneur repart de zÃ©ro.

ğŸ‘‰ Cela est acceptable pour des applications stateless (API, microservices),
mais pas pour des services stateful (bases de donnÃ©es, caches, systÃ¨mes de fichiers).

Pour rÃ©soudre cela, Kubernetes introduit une **abstraction du stockage** afin d'Ãªtre agnostique.

---

## 3. Les Volumes Kubernetes

### ğŸ“¦ Quâ€™est-ce quâ€™un volume ?

Un **volume** est un espace de stockage attachÃ© Ã  un pod.
Contrairement au stockage interne du conteneur :

* il **survit au redÃ©marrage** du conteneur (tant que le pod existe),
* et peut Ãªtre **partagÃ© entre plusieurs conteneurs** du mÃªme pod.

### ğŸ”§ DÃ©finition simple :

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: demo
spec:
  containers:
  - name: app
    image: nginx
    volumeMounts:
    - name: data
      mountPath: /usr/share/nginx/html
  volumes:
  - name: data
    emptyDir: {}
```

Ici :

* `emptyDir` crÃ©e un volume vide sur le disque local du nÅ“ud,
* il existe tant que le pod tourne,
* mais est supprimÃ© quand le pod disparaÃ®t.

ğŸ‘‰ Câ€™est donc un stockage **temporaire**, pas persistant.

---

## 4. Les types de volumes

Kubernetes propose plusieurs types de volumes selon les besoins.

| Type                                                     | Persistance     | Description                                                            |
| -------------------------------------------------------- | --------------- | ---------------------------------------------------------------------- |
| **emptyDir**                                             | âŒ non           | Stockage temporaire, disparaÃ®t avec le pod                             |
| **hostPath**                                             | âš ï¸ partielle    | Monte un dossier du nÅ“ud local (ex. `/data`)                           |
| **nfs**                                                  | âœ… oui           | Monte un partage rÃ©seau (NFS)                                          |
| **configMap / secret**                                   | âš™ï¸ non (config) | Fournit des fichiers de configuration ou clÃ©s                          |
| **persistentVolumeClaim (PVC)**                          | âœ… oui           | Abstraction standard pour le stockage persistant                       |
| **csi (Container Storage Interface)**                    | âœ… oui           | Interface moderne et extensible pour tous les fournisseurs de stockage |

---

## 5. Persistent Volumes (PV) et Persistent Volume Claims (PVC)

Pour gÃ©rer le stockage **indÃ©pendamment des pods**, Kubernetes introduit deux ressources complÃ©mentaires :
le **Persistent Volume (PV)** et le **Persistent Volume Claim (PVC)**.

### ğŸ§± PV â€” Persistent Volume

Un **PV** est une ressource de stockage **provisionnÃ©e dans le cluster** (manuellement ou dynamiquement).
Il dÃ©crit un espace disque rÃ©el (local, NFS, Cloud, etc.) :

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-demo
spec:
  capacity:
    storage: 10Gi
  accessModes:
  - ReadWriteOnce
  hostPath:
    path: /mnt/data
```

### ğŸ¯ PVC â€” Persistent Volume Claim

Un **PVC** est une **demande de stockage** Ã©mise par un pod.
Câ€™est la maniÃ¨re dÃ©clarative de dire : â€œJe veux 10Go de stockage en lecture/Ã©critureâ€.

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-demo
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
```

Kubernetes fait correspondre automatiquement le **PVC** Ã  un **PV** compatible selon la capacitÃ© et les rÃ¨gles dâ€™accÃ¨s.

---

## 6. Liens entre Pods, PVC et PV

ğŸ“„ ChaÃ®ne complÃ¨te :

```
Pod â†’ PVC â†’ PV â†’ Backend de stockage
```

* Le **pod** dÃ©clare quâ€™il utilise un **PVC**.
* Le **PVC** rÃ©clame de lâ€™espace Ã  un **PV** existant (ou dÃ©clenche une crÃ©ation automatique).
* Le **PV** reprÃ©sente le volume rÃ©el sur un disque, une VM ou un service cloud.

ğŸ‘‰ Cela permet de **dÃ©tacher complÃ¨tement** le cycle de vie du pod de celui du stockage.

---

## âš™ï¸ 7. Dynamic Provisioning

PlutÃ´t que de crÃ©er manuellement chaque PV, on peut laisser Kubernetes le faire grÃ¢ce Ã  un **StorageClass**.
Le StorageClass dÃ©crit le type de stockage Ã  utiliser (SSD, HDD, NFS, cloud providerâ€¦).

Exemple :

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp3
```

Puis le PVC rÃ©fÃ©rence simplement cette classe :

```yaml
spec:
  storageClassName: fast-ssd
```

Kubernetes crÃ©e alors le **PV automatiquement** Ã  la demande.

> ğŸ’¡ Câ€™est le mÃ©canisme de *Dynamic Provisioning* â€” essentiel dans les environnements cloud.

---

## ğŸ§© 8. Modes dâ€™accÃ¨s au stockage

| Mode                    | Description                                 | Exemple dâ€™usage                                       |
| ----------------------- | ------------------------------------------- | ----------------------------------------------------- |
| **ReadWriteOnce (RWO)** | Lecture/Ã©criture par un seul nÅ“ud Ã  la fois | Base de donnÃ©es                                       |
| **ReadOnlyMany (ROX)**  | Lecture seule par plusieurs nÅ“uds           | Contenu statique                                      |
| **ReadWriteMany (RWX)** | Lecture/Ã©criture partagÃ©e                   | Applications distribuÃ©es (WordPress, Nextcloud, etc.) |

Les modes disponibles dÃ©pendent du **backend de stockage** (ex. NFS, EFS, Ceph, etc.).

---

## ğŸ’¡ 9. CSI : la nouvelle norme du stockage

Le **Container Storage Interface (CSI)** est une norme qui unifie la maniÃ¨re dont Kubernetes interagit avec les systÃ¨mes de stockage.
GrÃ¢ce Ã  CSI :

* les fournisseurs (AWS, Azure, Ceph, etc.) peuvent dÃ©velopper leurs propres pilotes sans modifier Kubernetes ;
* les fonctionnalitÃ©s sont Ã©tendues : snapshots, expansions de volume, etc.

Exemples de drivers CSI :

* **AWS EBS CSI Driver**
* **Azure Disk CSI Driver**
* **Ceph RBD CSI**
* **Longhorn CSI (Rancher)**

> ğŸ“¦ Kubernetes ne gÃ¨re plus directement les disques â€” il dÃ©lÃ¨gue Ã  CSI.

---

## ğŸ—ƒï¸ 10. Les volumes spÃ©ciaux : ConfigMap et Secret

Tous les volumes ne servent pas Ã  stocker des fichiers utilisateurs.
Certains sont utilisÃ©s pour **injecter des configurations** ou **donnÃ©es sensibles**.

### ConfigMap

Contient des variables de configuration non sensibles :

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  APP_MODE: "production"
```

### Secret

Contient des donnÃ©es sensibles encodÃ©es en base64 :

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: db-secret
data:
  password: cGFzc3dvcmQ=
```

Les deux peuvent Ãªtre montÃ©s comme volumes :

```yaml
volumeMounts:
- name: config
  mountPath: /etc/config
```

---

## ğŸ§  11. Exemple concret : base de donnÃ©es persistante

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:15
        volumeMounts:
        - mountPath: /var/lib/postgresql/data
          name: postgres-storage
      volumes:
      - name: postgres-storage
        persistentVolumeClaim:
          claimName: postgres-pvc
```

â†’ Ici, mÃªme si le pod PostgreSQL est redÃ©ployÃ©, ses donnÃ©es sont conservÃ©es car elles sont stockÃ©es sur un **PVC**.

---

## âœ… 12. RÃ©sumÃ©

| Concept                         | Description                                                         | DurÃ©e de vie           |
| ------------------------------- | ------------------------------------------------------------------- | ---------------------- |
| **Volume**                      | Espace de stockage montÃ© dans un pod                                | Tant que le pod existe |
| **PersistentVolumeClaim (PVC)** | Demande de stockage dâ€™un pod                                        | IndÃ©pendante du pod    |
| **PersistentVolume (PV)**       | Ressource de stockage rÃ©elle dans le cluster                        | IndÃ©pendante du pod    |
| **StorageClass**                | DÃ©finit la politique et le type de stockage                         | Automatique            |
| **CSI**                         | Interface standard entre Kubernetes et les fournisseurs de stockage | Permanente             |

---

## ğŸ” 13. Ã€ retenir

* Les **pods sont Ã©phÃ©mÃ¨res**, mais les **donnÃ©es ne doivent pas lâ€™Ãªtre**.
* Les **volumes** permettent le stockage local ou partagÃ©.
* Les **PVC/PV** assurent la **persistance et la portabilitÃ©**.
* Le **CSI** apporte une extensibilitÃ© universelle.
* Et les **StorageClass** automatisent le provisionnement selon les besoins.

Kubernetes transforme ainsi un environnement dynamique en un systÃ¨me **stateful**, capable dâ€™hÃ©berger aussi bien des microservices que des bases de donnÃ©es critiques â€” sans sacrifier la rÃ©silience ni lâ€™automatisation.
