# ðŸ§° Helm: gestion des packages Kubernetes

## 1. Introduction

Helm est le gestionnaire de packages de Kubernetes. Il permet de versionner, paramÃ©trer et dÃ©ployer des applications via des Â« Charts Â» (modÃ¨les + valeurs).

Objectifsâ€‰:

- Comprendre la structure dâ€™un Chart
- MaÃ®triser `values` et le templating
- GÃ©rer dÃ©pendances, versions et releases
- Automatiser dÃ©ploiements et mises Ã  jour

---

## 2. Concepts clÃ©s

- Chartâ€‰: package applicatif (templates + valeurs + mÃ©tadonnÃ©es)
- Releaseâ€‰: instance dÃ©ployÃ©e dâ€™un Chart dans un cluster
- Repositoryâ€‰: source de Charts (HTTP/OCI)
- Templatingâ€‰: Go templates + fonctions Sprig appliquÃ©es aux fichiers YAML

---

## 3. Structure dâ€™un Chart

```
my-chart/
  Chart.yaml            # MÃ©tadonnÃ©es du chart
  values.yaml           # Valeurs par dÃ©faut
  values.schema.json    # (optionnel) SchÃ©ma de validation des valeurs
  templates/            # Manifests Kubernetes templatÃ©s
  charts/               # DÃ©pendances (si vendored)
```

Exemple de `Chart.yaml`â€‰:

```yaml
apiVersion: v2
name: webapp
description: Chart de dÃ©ploiement de webapp
type: application
version: 0.1.0
appVersion: "1.0.0"
dependencies:
  - name: redis
    version: 17.x.x
    repository: https://charts.bitnami.com/bitnami
    condition: redis.enabled
```

Exemple de `values.yaml`â€‰:

```yaml
image:
  repository: ghcr.io/acme/webapp
  tag: "1.0.0"
  pullPolicy: IfNotPresent
replicaCount: 2
service:
  type: ClusterIP
  port: 80
ingress:
  enabled: true
  className: nginx
  hosts:
    - host: webapp.example.com
      paths:
        - path: /
          pathType: Prefix
redis:
  enabled: true
```

---

## 4. Templates essentiels

Deployment (extrait) `templates/deployment.yaml`â€‰:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "webapp.fullname" . }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "webapp.name" . }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "webapp.name" . }}
    spec:
      containers:
        - name: webapp
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: 80
```

Ingress conditionnel `templates/ingress.yaml`â€‰:

```yaml
{{- if .Values.ingress.enabled }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "webapp.fullname" . }}
spec:
  ingressClassName: {{ .Values.ingress.className }}
  rules:
  {{- range .Values.ingress.hosts }}
  - host: {{ .host }}
    http:
      paths:
      {{- range .paths }}
      - path: {{ .path }}
        pathType: {{ .pathType }}
        backend:
          service:
            name: {{ include "webapp.fullname" $ }}
            port:
              number: {{ $.Values.service.port }}
      {{- end }}
  {{- end }}
{{- end }}
```

Notesâ€‰:

- `include` appelle des helpers dÃ©finis dans `_helpers.tpl` (naming labels, fullname, etc.)
- `if`/`range` contrÃ´lent le rendu selon les valeurs

---

## 5. Commandes de base

- `helm repo add bitnami https://charts.bitnami.com/bitnami`
- `helm repo update`
- `helm search repo redis`
- `helm pull oci://ghcr.io/acme/charts/webapp --version 0.1.0`
- `helm install webapp ./my-chart -n prod`
- `helm upgrade webapp ./my-chart -f values-prod.yaml -n prod`
- `helm rollback webapp 3 -n prod`
- `helm uninstall webapp -n prod`
- `helm template ./my-chart -f values-prod.yaml | kubectl apply -f -` (mode GitOps simple)

---

## 6. Gestion des valeurs

Ordre de prioritÃ© (du plus fort au plus faible)â€‰:

- `--set key=val` et `--set-file`
- `-f values-*.yaml` (du dernier au premier)
- `values.yaml` du chart

Exemplesâ€‰:

```bash
helm upgrade webapp ./my-chart \
  -f values-prod.yaml \
  -f values-secrets.yaml \
  --set image.tag=1.1.0 \
  -n prod
```

Validation via `values.schema.json`â€‰:

```json
{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "replicaCount": { "type": "integer", "minimum": 1 },
    "image": {
      "type": "object",
      "properties": { "repository": {"type": "string"}, "tag": {"type": "string"} },
      "required": ["repository", "tag"]
    }
  },
  "required": ["replicaCount", "image"]
}
```

---

## 7. DÃ©pendances et sousâ€‘charts

- DÃ©clarer dans `Chart.yaml > dependencies`
- Activer/dÃ©sactiver via `condition: foo.enabled`
- RÃ©cupÃ©rerâ€‰: `helm dependency update` (ou vendorer dans `charts/`)

Exemples dâ€™usage dans les templatesâ€‰:

```yaml
{{- if .Values.redis.enabled }}
{{- $redis := .Values.redis }}
# Utiliser {{ .Release.Name }}-redis-master:6379 comme backend
{{- end }}
```

---

## 8. Hooks, tests et lifecycle

Hooksâ€‰: exÃ©cuter des tÃ¢ches avant/aprÃ¨s install/upgrade/rollback.

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "webapp.fullname" . }}-migrate
  annotations:
    "helm.sh/hook": pre-upgrade,pre-install
    "helm.sh/hook-weight": "-5"
spec: { ... }
```

Tests Helmâ€‰: crÃ©er des pods marquÃ©s `helm.sh/hook: test` puisâ€‰:

```bash
helm test webapp -n prod
```

---

## 9. SÃ©curitÃ© et secrets

- Eviter `--set password=...` (apparaÃ®t en clair dans lâ€™historique)
- PrÃ©fÃ©rer `-f values-secrets.yaml` gÃ©rÃ© par un coffre (SOPS, External Secrets)
- Scanner les charts et images (policies, admission controllers)

SOPS + Helm (ex.)â€‰:

```bash
sops -e values-secrets.yaml > values-secrets.enc.yaml
helm upgrade webapp ./my-chart -f <(sops -d values-secrets.enc.yaml)
```

---

## 10. Helm et GitOps

- Helmfile: orchestre plusieurs releases, environnements, valeurs
- Argo CD / Flux: dÃ©ploient des charts depuis Git (ou OCI), gÃ¨rent drift et sync

Exemple Helmfile minimalâ€‰:

```yaml
releases:
  - name: webapp
    namespace: prod
    chart: ./my-chart
    values:
      - values-prod.yaml
```

---

## 11. Packaging, versioning et OCI

- Packager: `helm package ./my-chart` â†’ `webapp-0.1.0.tgz`
- Index HTTP: `helm repo index .` puis servir via web
- OCI registry: `helm push oci://ghcr.io/acme/charts`
- Versionner `version` (chart) et `appVersion` (app) sÃ©parÃ©ment

---

## 12. Bonnes pratiques

- Petits templates lisibles, helpers pour les labels et noms
- `values.schema.json` pour valider et documenter les valeurs
- GÃ©rer lâ€™immutabilitÃ© des noms et selectors (Ã©viter les cassures lors dâ€™upgrade)
- Probes, ressources, affinities paramÃ©trables via `values`
- Rendre lâ€™ingress et la persistance optionnels
- Toujours `helm template` dans CI pour valider le rendu

---

## 13. RÃ©sumÃ©

Helm industrialise les dÃ©ploiements Kubernetesâ€‰: packaging, paramÃ©trage, dÃ©pendances et upgrades contrÃ´lÃ©s. MaÃ®triser Charts, valeurs et hooks vous donne des dÃ©ploiements reproductibles, sÃ»rs et adaptÃ©s Ã  chaque environnement.

